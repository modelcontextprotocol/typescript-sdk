name: Conformance Tests

on:
  push:
    branches: [main]
  pull_request:
  workflow_dispatch:

concurrency:
  group: conformance-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  client-conformance:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          run_install: false
      - uses: actions/setup-node@v4
        with:
          node-version: 24
          cache: pnpm
          cache-dependency-path: pnpm-lock.yaml
      - run: pnpm install
      - run: pnpm run build:all
      - uses: modelcontextprotocol/conformance@4a42c25058c4636aca1ae7f6547ee30805de36ee
        with:
          mode: client
          command: "npx tsx src/conformance/everything-client.ts"
          suite: all
          expected-failures: ./conformance-baseline.yml
          node-version: "24"

  server-conformance:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          run_install: false
      - uses: actions/setup-node@v4
        with:
          node-version: 24
          cache: pnpm
          cache-dependency-path: pnpm-lock.yaml
      - run: pnpm install
      - run: pnpm run build:all
      - name: Start everything-server
        run: |
          npx tsx src/conformance/everything-server.ts &
          timeout 15 bash -c 'until curl -s http://localhost:3000/mcp > /dev/null 2>&1; do sleep 0.5; done'
          echo "Server ready"
      - uses: modelcontextprotocol/conformance@4a42c25058c4636aca1ae7f6547ee30805de36ee
        with:
          mode: server
          url: http://localhost:3000/mcp
          expected-failures: ./conformance-baseline.yml
          node-version: "24"
